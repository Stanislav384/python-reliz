import sys
from PyQt5.QtCore import QUrl
from PyQt5.QtWidgets import QApplication, QMainWindow, QFileDialog
from ui import Ui_MainWindow
import os 
from PyQt5.QtCore import Qt
from PyQt5.QtGui import QPixmap 
from PIL import Image, ImageFilter

class ImageProcessor():
    def __init__(self):
        self.image = None 
        self.dir = None 
        self.filename = None 
        self.save_dir = "Modified/"

    def loadImage(self, dir, filename):
        self.dir = dir 
        self.filename = filename 
        image_path = os.path.join(dir, filename)
        self.image = Image.open(image_path)
    
    def showImage(self, label_widget, path):
        label_widget.hide()
        pixmapimage = QPixmap(path)
        w, h = label_widget.width(), label_widget.height()

        pixmapimage = pixmapimage.scaled(w, h, Qt.KeepAspectRatio, Qt.SmoothTransformation)
        label_widget.setPixmap(pixmapimage)
        label_widget.show()
    
    def saveImage(self):
        path = os.path.join(self.dir, self.save_dir)
        if not os.path.exists(path) or not os.path.isdir(path):
            os.mkdir(path)
        image_path = os.path.join(path, self.filename)
        self.image.save(image_path, quality=95)
        return image_path


    def do_left(self):
        self.image = self.image.transpose(Image.ROTATE_90)
        return self.saveImage()
    
    def do_right(self):
        self.image = self.image.transpose(Image.ROTATE_270)
        return self.saveImage()
    
    def do_flip(self):
        self.image = self.image.transpose(Image.FLIP_LEFT_RIGHT)
        return self.saveImage()
    
    def do_bw(self):
        self.image = self.image.convert("L")
        return self.saveImage()
    
    def do_sharpen(self):
        self.image = self.image.filter(ImageFilter.SHARPEN)
        return self.saveImage()

class Widget(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        self.configure()
        self.workdir = ''
        self.workimage = ImageProcessor()
        # ЦЕ РОЗМІР ФОТО!
        self.ui.image.resize(600, 400)
        # ЦЕ ЗДВИГ ФОТО! 
        self.ui.image.move(180, 60)
        
    def configure(self):
        self.ui.open_folder.clicked.connect(self.showFilenamesList)
        self.ui.list_image.currentRowChanged.connect(self.showChosenImage)
        # ДОДАЄМО ФУНКЦІОНАЛ ДЛЯ КНОПОК)
        self.ui.rotate_left.clicked.connect(self.work_left)
        self.ui.rotate_right.clicked.connect(self.work_right)
        self.ui.mirror_image.clicked.connect(self.work_mirror)
        self.ui.sharpness_image.clicked.connect(self.work_sharpen)
        self.ui.black_white.clicked.connect(self.work_bw)


    def work_left(self):
        path = self.workimage.do_left()
        self.workimage.showImage(self.ui.image, path)

    def work_right(self):
        path = self.workimage.do_right()
        self.workimage.showImage(self.ui.image, path)

    def work_mirror(self):
        path = self.workimage.do_flip()
        self.workimage.showImage(self.ui.image, path)
    
    def work_bw(self):
        path = self.workimage.do_bw()
        self.workimage.showImage(self.ui.image, path)

    def work_sharpen(self):
        path = self.workimage.do_sharpen()
        self.workimage.showImage(self.ui.image, path)
    

    def filter(self, files, extensions):
        result = []
        for filename in files:
            for ext in extensions:
                if filename.lower().endswith(ext):
                    result.append(filename)
                    break 
        return result 
    
    def showFilenamesList(self):
        # 1. Спочатку отримую папку яку я вибрав.
        dir_path = QFileDialog.getExistingDirectory(self, "Оберіть папку: ")
        # 2. Перевіряю чи я взагалі щось вибрав. (вибрав папку)
        if dir_path:
            # 3. Якщо я вибрав папку, то я з dir_path (тут посилання на папку) переносю в workdir
            self.workdir = dir_path 
            # 4. Це розширення фото які я буду потім фільтрувати.
            extensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp']
            # 5. Витягую УСІ файли (без фільтру) і зберігаю їх у змінну.
            all_files_in_dir = os.listdir(self.workdir)
            # 6. Фільтрація (З нею я отримаю ТІЛЬКИ ті файли в яких є формат вказаний в extensions)
            filenames = self.filter(all_files_in_dir, extensions)
            # 7. Оновлення списку на екрані.
            self.ui.list_image.clear()
            self.ui.list_image.addItems(filenames)
    
    def showChosenImage(self):
        if self.ui.list_image.currentRow() >= 0:
            filename = self.ui.list_image.currentItem().text()
            self.workimage.loadImage(self.workdir, filename)
            image_path = os.path.join(self.workimage.dir, self.workimage.filename)
            self.workimage.showImage(self.ui.image, image_path)


if __name__ == '__main__':
    app = QApplication(sys.argv)
    ex = Widget()
    ex.show()
    sys.exit(app.exec_())



